import React, { useState, useRef, useEffect } from 'react';
import { Upload, FileText, Send, BrainCircuit, X, Loader, User, Bot, File as FileIcon, Mic, StopCircle, Trash2, AlertTriangle, ShieldCheck, BookMarked, Download, ChevronDown, Settings, FolderPlus, PanelLeftClose, PanelLeftOpen, Database } from 'lucide-react';

// --- C·∫•u h√¨nh Gemini API, s·ª≠ d·ª•ng model t∆∞∆°ng th√≠ch ---
const API_KEY = "AIzaSyBVVvBuZGIJfKWKldzBVystGcRTk4QqxTc"; 
const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

// --- D·ªØ li·ªáu kh·ªüi t·∫°o cho C∆° s·ªü tri th·ª©c ---
const INITIAL_KNOWLEDGE_BASE = `**Ch√≠nh s√°ch ngh·ªâ ph√©p nƒÉm 2025 c·ªßa C√¥ng ty ABC**
1.  **S·ªë ng√†y ngh·ªâ ph√©p ti√™u chu·∫©n:** 15 ng√†y/nƒÉm cho nh√¢n vi√™n ch√≠nh th·ª©c.
2.  **Quy ƒë·ªãnh ƒëƒÉng k√Ω:** Ph·∫£i ƒëƒÉng k√Ω tr∆∞·ªõc √≠t nh·∫•t 3 ng√†y l√†m vi·ªác.
`;

const INITIAL_BOT_MESSAGE = {
  sender: 'bot',
  text: "Xin ch√†o! üëã T√¥i l√† Tr·ª£ l√Ω AI c√≥ kh·∫£ nƒÉng t√πy bi·∫øn!\n\nNh·∫•n v√†o n√∫t **C√†i ƒë·∫∑t** (h√¨nh b√°nh rƒÉng) ·ªü g√≥c tr√™n b√™n tr√°i ƒë·ªÉ ƒë·ªãnh h√¨nh vai tr√≤ v√† t√≠nh c√°ch cho t√¥i. T√¥i s·∫Ω lu√¥n tu√¢n theo ch·ªâ th·ªã c·ªßa b·∫°n trong m·ªçi cu·ªôc tr√≤ chuy·ªán.\n\nH√£y b·∫Øt ƒë·∫ßu kh√°m ph√° nh√©!",
};

// --- Component C√†i ƒë·∫∑t ---
const SettingsModal = ({ isOpen, onClose, context, onSave }) => {
    const [localContext, setLocalContext] = useState(context);
    useEffect(() => { setLocalContext(context); }, [context]);
    if (!isOpen) return null;
    const handleSave = () => { onSave(localContext); onClose(); };

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Settings size={24} /> C√†i ƒë·∫∑t Ng·ªØ c·∫£nh AI</h2>
                    <button onClick={onClose} className="text-slate-500 hover:text-slate-800"><X size={24} /></button>
                </div>
                <p className="text-sm text-slate-600 mb-4">T·∫°i ƒë√¢y, b·∫°n c√≥ th·ªÉ ch·ªâ th·ªã cho AI v·ªÅ vai tr√≤, t√≠nh c√°ch ho·∫∑c phong c√°ch tr·∫£ l·ªùi. AI s·∫Ω lu√¥n tu√¢n theo ng·ªØ c·∫£nh n√†y trong m·ªçi ph·∫£n h·ªìi.</p>
                <textarea value={localContext} onChange={(e) => setLocalContext(e.target.value)} placeholder="V√≠ d·ª•: B·∫°n l√† m·ªôt tr·ª£ l√Ω marketing vui t√≠nh..." className="w-full h-40 p-2 border border-slate-300 rounded-md resize-none text-sm bg-slate-50 focus:ring-2 focus:ring-indigo-500" />
                <div className="mt-6 flex justify-end gap-3">
                    <button onClick={onClose} className="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">H·ªßy</button>
                    <button onClick={handleSave} className="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">L∆∞u thay ƒë·ªïi</button>
                </div>
            </div>
        </div>
    );
};

// --- Component Ch√≠nh C·ªßa ·ª®ng D·ª•ng ---
export default function App() {
  const [projects, setProjects] = useState([]);
  const [activeProjectId, setActiveProjectId] = useState(null);
  const [isSidebarOpen, setIsSidebarOpen] = useState(true);

  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [isPdfScriptLoaded, setPdfScriptLoaded] = useState(false);
  const [isMammothScriptLoaded, setMammothScriptLoaded] = useState(false);
  const [isXlsxScriptLoaded, setIsXlsxScriptLoaded] = useState(false);

  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  const [aiContext, setAiContext] = useState('B·∫°n l√† m·ªôt tr·ª£ l√Ω AI chuy√™n nghi·ªáp, th√¢n thi·ªán v√† lu√¥n tr·∫£ l·ªùi m·ªôt c√°ch s√∫c t√≠ch.');
  const [isListening, setIsListening] = useState(false);
  const abortControllerRef = useRef(null);
  const recognitionRef = useRef(null);
  const messagesEndRef = useRef(null);

  // --- [S·ª¨A L·ªñI] G·ª° b·ªè localStorage v√† kh·ªüi t·∫°o d·ª± √°n m·∫∑c ƒë·ªãnh ---
  useEffect(() => {
    // Lu√¥n kh·ªüi t·∫°o m·ªôt d·ª± √°n m·ªõi khi ·ª©ng d·ª•ng t·∫£i ƒë·ªÉ tr√°nh l·ªói x√°c th·ª±c t·ª´ localStorage
    const firstProjectId = Date.now();
    const firstProject = {
        id: firstProjectId,
        name: 'D·ª± √°n ƒë·∫ßu ti√™n',
        messages: [INITIAL_BOT_MESSAGE],
        files: [],
        knowledgeBase: INITIAL_KNOWLEDGE_BASE,
        isKnowledgeBaseCollapsed: false,
    };
    setProjects([firstProject]);
    setActiveProjectId(firstProjectId);
  }, []); // M·∫£ng r·ªóng ƒë·∫£m b·∫£o useEffect ch·ªâ ch·∫°y m·ªôt l·∫ßn khi component mount


  const scrollToBottom = () => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); };

  // --- T·∫£i c√°c th∆∞ vi·ªán c·∫ßn thi·∫øt ---
  useEffect(() => {
    const loadScript = (id, src, onLoad) => {
        if (!document.getElementById(id)) {
            const script = document.createElement('script');
            script.id = id; script.src = src; script.onload = onLoad;
            document.body.appendChild(script);
        } else { onLoad(); }
    };
    loadScript('pdfjs-script', 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js', () => {
        if(window.pdfjsLib) { window.pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`; }
        setPdfScriptLoaded(true);
    });
    loadScript('mammoth-script', 'https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js', () => setMammothScriptLoaded(true));
    loadScript('xlsx-script', 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js', () => setIsXlsxScriptLoaded(true));
  }, []);

  useEffect(() => {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) return;
    recognitionRef.current = new SpeechRecognition();
    recognitionRef.current.continuous = false; recognitionRef.current.lang = 'vi-VN'; recognitionRef.current.interimResults = false;
    recognitionRef.current.onresult = (event) => setInput(prev => prev + event.results[0][0].transcript);
    recognitionRef.current.onend = () => setIsListening(false);
    recognitionRef.current.onerror = () => setIsListening(false);
  }, []);

  useEffect(() => { scrollToBottom(); }, [projects, activeProjectId]);

  const updateActiveProject = (updateFn) => setProjects(prev => prev.map(p => p.id === activeProjectId ? updateFn(p) : p));

  const callGeminiAPI = async (prompt, signal) => {
    try {
      const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
      const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal });
      if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
      const result = await response.json();
      if (result.candidates && result.candidates.length > 0) return result.candidates[0].content.parts[0].text;
      return "R·∫•t ti·∫øc, t√¥i kh√¥ng th·ªÉ x·ª≠ l√Ω y√™u c·∫ßu c·ªßa b·∫°n l√∫c n√†y.";
    } catch (error) {
      if (error.name === 'AbortError') return 'Qu√° tr√¨nh ƒë√£ ƒë∆∞·ª£c d·ª´ng b·ªüi ng∆∞·ªùi d√πng.';
      console.error('Error calling Gemini API:', error);
      return `ƒê√£ x·∫£y ra l·ªói: ${error.message}.`;
    }
  };
  
  const readFileContent = async (file) => {
    const docxType = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
    const xlsxType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
    const csvType = 'text/csv';

    if (file.type.startsWith('text/') || file.type === csvType) {
      return await file.text();
    } else if (file.type === 'application/pdf' && isPdfScriptLoaded) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await window.pdfjsLib.getDocument(arrayBuffer).promise;
      if (pdf.numPages === 0) throw new Error("File PDF r·ªóng ho·∫∑c b·ªã l·ªói.");
      let textContent = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const text = await page.getTextContent();
        textContent += text.items.map(s => s.str).join(' ') + '\n';
      }
      return textContent;
    } else if (file.type === docxType && isMammothScriptLoaded) {
      const arrayBuffer = await file.arrayBuffer();
      const result = await window.mammoth.extractRawText({ arrayBuffer: arrayBuffer });
      if (!result.value) throw new Error("Kh√¥ng th·ªÉ tr√≠ch xu·∫•t n·ªôi dung t·ª´ file .docx.");
      return result.value;
    } else if (file.type === xlsxType && isXlsxScriptLoaded) {
      const arrayBuffer = await file.arrayBuffer();
      const workbook = window.XLSX.read(arrayBuffer, { type: 'buffer' });
      let fullText = '';
      workbook.SheetNames.forEach(sheetName => {
        fullText += `--- Trang t√≠nh: ${sheetName} ---\n`;
        const worksheet = workbook.Sheets[sheetName];
        const text = window.XLSX.utils.sheet_to_csv(worksheet);
        fullText += text + '\n\n';
      });
      if (!fullText) throw new Error("Kh√¥ng th·ªÉ tr√≠ch xu·∫•t n·ªôi dung t·ª´ file .xlsx.");
      return fullText;
    } else {
      throw new Error(`ƒê·ªãnh d·∫°ng file "${file.name}" kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£.`);
    }
  }

  const handleFileChange = async (event) => {
    const newFiles = Array.from(event.target.files);
    if (newFiles.length === 0) return;
    setIsLoading(true);
    updateActiveProject(p => ({...p, messages: [...p.messages, {sender: 'system', text: `ƒêang x·ª≠ l√Ω ${newFiles.length} t·ªáp...`, type: 'info'}]}));
    
    let successCount = 0;
    for (const file of newFiles) {
      try {
        const fileContent = await readFileContent(file);
        updateActiveProject(p => ({...p, files: [...p.files, { name: file.name, content: fileContent }]}));
        successCount++;
      } catch (error) {
          updateActiveProject(p => ({...p, messages: [...p.messages, {sender: 'system', text: `L·ªói: ${error.message}`, type: 'error'}]}));
      }
    }
    setIsLoading(false);
    updateActiveProject(p => ({...p, messages: [...p.messages, {sender: 'system', text: `Ho√†n t·∫•t x·ª≠ l√Ω. ƒê√£ th√™m ${successCount}/${newFiles.length} t·ªáp v√†o danh s√°ch T√†i li·ªáu.`, type: 'info'}]}));
  };

  const handleKnowledgeBaseUpload = async (event) => {
    const file = event.target.files[0];
    if (!file) return;
    setIsLoading(true);
    updateActiveProject(p => ({...p, messages: [...p.messages, {sender: 'system', text: `ƒêang n·∫°p C∆° s·ªü tri th·ª©c t·ª´ file "${file.name}"...`, type: 'info'}]}));
    try {
        const content = await readFileContent(file);
        updateActiveProject(p => ({...p, knowledgeBase: p.knowledgeBase.trim() + '\n\n' + content}));
        updateActiveProject(p => ({...p, messages: [...p.messages, {sender: 'system', text: `ƒê√£ th√™m th√†nh c√¥ng n·ªôi dung t·ª´ file v√†o C∆° s·ªü tri th·ª©c.`, type: 'info'}]}));
    } catch (error) {
        updateActiveProject(p => ({...p, messages: [...p.messages, {sender: 'system', text: `L·ªói: ${error.message}`, type: 'error'}]}));
    }
    setIsLoading(false);
    event.target.value = null;
  };

  const handleDownloadKnowledgeBase = () => {
    const activeProject = projects.find(p => p.id === activeProjectId);
    if (!activeProject) return;
    const blob = new Blob([activeProject.knowledgeBase], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `cskt_${activeProject.name.replace(/\s/g, '_')}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  const handleClearAllFiles = () => {
    updateActiveProject(p => ({...p, files: []}));
    updateActiveProject(p => ({...p, messages: [...p.messages, {sender: 'system', text: 'ƒê√£ x√≥a t·∫•t c·∫£ t√†i li·ªáu t·∫£i l√™n t·∫°m th·ªùi.', type: 'info'}]}));
  };

  const handleAddToKnowledge = () => {
    if (input.trim() === '') return;
    updateActiveProject(p => ({...p, knowledgeBase: p.knowledgeBase.trim() + '\n\n' + input.trim()}));
    updateActiveProject(p => ({...p, messages: [...p.messages, {sender: 'system', text: `ƒê√£ ghi nh·ªõ th√¥ng tin m·ªõi v√†o C∆° s·ªü tri th·ª©c.`, type: 'info'}]}));
    setInput('');
  };

  const processRequest = async (mode) => {
    if (input.trim() === '' || isLoading) return;
    const activeProject = projects.find(p => p.id === activeProjectId);
    if (!activeProject) return;

    const userMessage = { sender: 'user', text: input };
    updateActiveProject(p => ({...p, messages: [...p.messages, userMessage]}));
    setInput('');
    setIsLoading(true);

    abortControllerRef.current = new AbortController();
    const signal = abortControllerRef.current.signal;
    
    const hasFiles = activeProject.files.length > 0;
    const fileContents = hasFiles ? activeProject.files.map(f => `--- B·∫Øt ƒë·∫ßu t√†i li·ªáu: ${f.name} ---\n${f.content}\n--- K·∫øt th√∫c t√†i li·ªáu: ${f.name} ---`).join('\n\n') : 'Kh√¥ng c√≥ t√†i li·ªáu n√†o.';
    
    const currentKnowledgeBase = activeProject.knowledgeBase;
    let modeSpecificPrompt;

    const CONTEXT_BLOCK = `
    **NGU·ªíN D·ªÆ LI·ªÜU ƒê·ªÇ TR·∫¢ L·ªúI (∆Øu ti√™n theo th·ª© t·ª±):**
    1.  **C∆† S·ªû TRI TH·ª®C N·ªòI B·ªò:**
        ${currentKnowledgeBase}
    2.  **T√ÄI LI·ªÜU (Bao g·ªìm file vƒÉn b·∫£n v√† file d·ªØ li·ªáu th√¥ .csv):**
        ${fileContents}
    `;

    switch(mode) {
      case 'expert':
      case 'deep_research':
        const reportTitle = mode === 'expert' ? 'B√°o c√°o Ph√¢n t√≠ch Chuy√™n s√¢u' : 'B√°o c√°o Ch√©m gi√≥ s√¢u';
        modeSpecificPrompt = `**Y√äU C·∫¶U C·ª¶A NG∆Ø·ªúI D√ôNG:**
        "${userMessage.text}"

        **VAI TR√í C·ª¶A B·∫†N:**
        B·∫°n l√† m·ªôt Chuy√™n gia Ph√¢n t√≠ch & L·∫≠p k·∫ø ho·∫°ch Chi·∫øn l∆∞·ª£c.

        **NHI·ªÜM V·ª§:**
        H√£y t·∫°o m·ªôt b·∫£n **${reportTitle}** ƒë·ªÉ tr·∫£ l·ªùi y√™u c·∫ßu c·ªßa ng∆∞·ªùi d√πng. B·∫°n PH·∫¢I tu√¢n th·ªß nghi√™m ng·∫∑t **QUY TR√åNH T∆Ø DUY ƒêA B∆Ø·ªöC** sau ƒë√¢y:

        * **B∆∞·ªõc 1: Ph√¢n r√£ Y√™u c·∫ßu.**
            * ƒê·ªçc k·ªπ y√™u c·∫ßu c·ªßa ng∆∞·ªùi d√πng v√† chia n√≥ th√†nh c√°c nhi·ªám v·ª• con. V√≠ d·ª•: "Ph√¢n t√≠ch thu nh·∫≠p hi·ªán t·∫°i" v√† "D·ª± b√°o thu nh·∫≠p t∆∞∆°ng lai".

        * **B∆∞·ªõc 2: Ph√¢n t√≠ch D·ªØ li·ªáu N·ªÅn t·∫£ng.**
            * Qu√©t qua to√†n b·ªô "NGU·ªíN D·ªÆ LI·ªÜU ƒê·ªÇ TR·∫¢ L·ªúI".
            * N·∫øu y√™u c·∫ßu ƒë√≤i h·ªèi t√≠nh to√°n tr√™n d·ªØ li·ªáu d·∫°ng b·∫£ng (CSV/Excel), h√£y th·ª±c hi·ªán c√°c ph√©p t√≠nh c·∫ßn thi·∫øt (t·ªïng, trung b√¨nh, t·ª∑ l·ªá, v.v.) ƒë·ªÉ l·∫•y ra c√°c s·ªë li·ªáu c·ªët l√µi cho vi·ªác ph√¢n t√≠ch.

        * **B∆∞·ªõc 3: X√¢y d·ª±ng M√¥ h√¨nh & Gi·∫£ ƒë·ªãnh (N·∫øu c·∫ßn d·ª± b√°o).**
            * N·∫øu ng∆∞·ªùi d√πng y√™u c·∫ßu d·ª± b√°o, h√£y d·ª±a tr√™n d·ªØ li·ªáu ƒë√£ ph√¢n t√≠ch ƒë·ªÉ ƒë∆∞a ra c√°c gi·∫£ ƒë·ªãnh h·ª£p l√Ω. V√≠ d·ª•: "Gi·∫£ ƒë·ªãnh t·ª∑ l·ªá l∆∞∆°ng/doanh thu kh√¥ng ƒë·ªïi", "Gi·∫£ ƒë·ªãnh c·∫•u tr√∫c l∆∞∆°ng c∆° b·∫£n v√† th∆∞·ªüng ƒë∆∞·ª£c gi·ªØ nguy√™n".

        * **B∆∞·ªõc 4: √Åp d·ª•ng K·ªãch b·∫£n & T√≠nh to√°n (N·∫øu c·∫ßn d·ª± b√°o).**
            * √Åp d·ª•ng c√°c k·ªãch b·∫£n c·ªßa ng∆∞·ªùi d√πng (v√≠ d·ª•: doanh thu tƒÉng 30%) v√†o m√¥ h√¨nh gi·∫£ ƒë·ªãnh ƒë·ªÉ t√≠nh to√°n k·∫øt qu·∫£ d·ª± b√°o.

        * **B∆∞·ªõc 5: T·ªïng h·ª£p B√°o c√°o.**
            * Tr√¨nh b√†y to√†n b·ªô qu√° tr√¨nh t∆∞ duy v√† k·∫øt qu·∫£ cu·ªëi c√πng d∆∞·ªõi d·∫°ng m·ªôt b√°o c√°o Markdown ho√†n ch·ªânh, c√≥ c·∫•u tr√∫c r√µ r√†ng.

        **QUY T·∫ÆC B·∫ÆT BU·ªòC:**
        * N·∫øu kh√¥ng c√≥ ƒë·ªß th√¥ng tin trong c√°c ngu·ªìn d·ªØ li·ªáu, h√£y n√™u r√µ ƒëi·ªÅu ƒë√≥ v√† c√°c gi·∫£ ƒë·ªãnh b·∫°n ph·∫£i t·ª± ƒë·∫∑t ra.
        * ƒê·ªëi v·ªõi ch·∫ø ƒë·ªô "H·ªèi Chuy√™n Gia", c·∫•m tuy·ªát ƒë·ªëi s·ª≠ d·ª•ng ki·∫øn th·ª©c b√™n ngo√†i c√°c ngu·ªìn d·ªØ li·ªáu ƒë∆∞·ª£c cung c·∫•p.
        * ƒê·ªëi v·ªõi ch·∫ø ƒë·ªô "Ch√©m gi√≥ s√¢u", n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu, b·∫°n ƒë∆∞·ª£c ph√©p ph√¢n t√≠ch d·ª±a tr√™n ki·∫øn th·ª©c chung.

        H√£y b·∫Øt ƒë·∫ßu th·ª±c hi·ªán quy tr√¨nh ngay b√¢y gi·ªù.`;
        break;

      default: // 'chat' mode
        modeSpecificPrompt = `**Nhi·ªám v·ª•:** Tr·∫£ l·ªùi c√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng. H√£y tu√¢n th·ªß quy tr√¨nh sau:
        1.  T√¨m ki·∫øm c√¢u tr·∫£ l·ªùi trong "NGU·ªíN D·ªÆ LI·ªÜU ƒê·ªÇ TR·∫¢ L·ªúI". N·∫øu c√¢u h·ªèi y√™u c·∫ßu t√≠nh to√°n v√† c√≥ file d·ªØ li·ªáu, h√£y t·ª± th·ª±c hi·ªán ph√©p t√≠nh.
        2.  N·∫øu kh√¥ng t√¨m th·∫•y, h√£y s·ª≠ d·ª•ng ki·∫øn th·ª©c chung c·ªßa b·∫°n ƒë·ªÉ tr·∫£ l·ªùi.
        
        **C√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng:** "${userMessage.text}"`;
        break;
    }

    const finalPrompt = `**NG·ªÆ C·∫¢NH CHUNG (B·∫ÆT BU·ªòC TU√ÇN THEO):**\n${aiContext}\n\n${CONTEXT_BLOCK}\n\n**NHI·ªÜM V·ª§ C·ª§ TH·ªÇ:**\n${modeSpecificPrompt}`;

    const botResponseText = await callGeminiAPI(finalPrompt, signal);
    updateActiveProject(p => ({...p, messages: [...p.messages, { sender: 'bot', text: botResponseText, isReport: (mode === 'deep_research' || mode === 'expert') }]}));
    setIsLoading(false);
    abortControllerRef.current = null;
  };

  const handleStop = () => abortControllerRef.current?.abort();
  const handleToggleListening = () => {
    if (isListening) { recognitionRef.current.stop(); } else { recognitionRef.current.start(); }
    setIsListening(!isListening);
  };

  const handleNewProject = () => {
    const newProjectId = Date.now();
    const newProject = {
      id: newProjectId, name: `D·ª± √°n m·ªõi ${projects.length + 1}`, messages: [INITIAL_BOT_MESSAGE], files: [],
      knowledgeBase: `ƒê√¢y l√† c∆° s·ªü tri th·ª©c cho ${`D·ª± √°n m·ªõi ${projects.length + 1}`}.`, isKnowledgeBaseCollapsed: false,
    };
    setProjects(prev => [...prev, newProject]);
    setActiveProjectId(newProjectId);
  };
  
  const activeProject = projects.find(p => p.id === activeProjectId);

  const SystemMessage = ({ msg }) => {
    const isError = msg.type === 'error';
    const bgColor = isError ? 'bg-amber-100' : 'bg-green-100';
    const textColor = isError ? 'text-amber-800' : 'text-green-800';
    const borderColor = isError ? 'border-amber-200' : 'border-green-200';
    const Icon = isError ? AlertTriangle : BrainCircuit;
    const iconColor = isError ? 'text-amber-500' : 'text-green-500';

    return (
      <div className="flex items-start gap-3 justify-start">
        <div className={`w-10 h-10 rounded-full ${bgColor} flex items-center justify-center flex-shrink-0`}><Icon size={24} className={iconColor} /></div>
        <div className={`max-w-xl p-4 rounded-xl ${bgColor} ${textColor} border ${borderColor} text-sm`}><p className="whitespace-pre-wrap">{msg.text}</p></div>
      </div>
    );
  };

  const allScriptsLoaded = isPdfScriptLoaded && isMammothScriptLoaded && isXlsxScriptLoaded;

  return (
    <>
      <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} context={aiContext} onSave={setAiContext} />
      <div className="flex h-screen font-sans bg-slate-100 text-gray-800">
        {/* Sidebar */}
        <aside className={`bg-white border-r border-slate-200 flex flex-col h-full transition-all duration-300 ${isSidebarOpen ? 'w-1/3 xl:w-1/4 p-6' : 'w-0 p-0 overflow-hidden'}`}>
          <div className="flex items-center justify-between gap-3 mb-4">
            <div className="flex items-center gap-3">
                <span className="p-2 bg-blue-100 text-blue-600 rounded-lg"><BrainCircuit size={28} /></span>
                <div><h1 className="text-xl font-bold text-slate-800">Tr·ª£ l√Ω AI</h1></div>
            </div>
            <button onClick={() => setIsSettingsOpen(true)} className="text-slate-500 hover:text-indigo-600" title="C√†i ƒë·∫∑t Ng·ªØ c·∫£nh AI"><Settings size={22} /></button>
          </div>
          
          <div className="border-t border-b border-slate-200 py-4 my-4">
            <button onClick={handleNewProject} className="w-full flex items-center justify-center gap-2 p-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700 transition-colors">
              <FolderPlus size={20} /><span>D·ª± √°n m·ªõi</span>
            </button>
            <div className="mt-4 space-y-2 max-h-24 overflow-y-auto">
              {projects.map(p => (
                <button key={p.id} onClick={() => setActiveProjectId(p.id)} className={`w-full text-left p-2 rounded-md text-sm ${activeProjectId === p.id ? 'bg-blue-100 text-blue-800 font-semibold' : 'hover:bg-slate-100'}`}>
                  {p.name}
                </button>
              ))}
            </div>
          </div>

          {activeProject && (
            <div className="flex-grow flex flex-col min-h-0">
            {/* Khu v·ª±c t·∫£i file t·∫°m th·ªùi */}
            <div className="flex-shrink-0 mb-4">
              <div className="flex justify-between items-center mb-2">
                <h2 className="text-lg font-semibold text-slate-700 flex items-center gap-2"><FileText size={20} /> T√†i li·ªáu</h2>
                {activeProject.files.length > 0 && (<button onClick={handleClearAllFiles} className="text-sm text-red-500 hover:text-red-700 flex items-center gap-1" title="X√≥a t·∫•t c·∫£ t√†i li·ªáu"><Trash2 size={16} /> X√≥a</button>)}
              </div>
              <label htmlFor="file-upload" className={`w-full cursor-pointer bg-green-50 hover:bg-green-100 border-2 border-dashed border-green-300 rounded-lg p-4 flex flex-col items-center justify-center text-center transition-colors ${isLoading || !allScriptsLoaded ? 'cursor-not-allowed opacity-50' : ''}`}>
                <Upload className="text-green-600 mb-1" size={24} /><span className="font-semibold text-green-700 text-sm">{allScriptsLoaded ? 'T·∫£i l√™n ƒë·ªÉ ph√¢n t√≠ch' : 'ƒêang t·∫£i...'}</span>
              </label>
              <input id="file-upload" type="file" multiple className="hidden" onChange={handleFileChange} disabled={isLoading || !allScriptsLoaded} accept=".txt,.pdf,.md,.docx,.xlsx,.csv" />
              {activeProject.files.length > 0 && <ul className="space-y-2 mt-2 max-h-40 overflow-y-auto">{activeProject.files.map((file, index) => (<li key={index} className="flex items-center justify-between bg-slate-50 p-2 rounded-md group"><div className="flex items-center gap-2 overflow-hidden"><FileIcon className="text-blue-500 flex-shrink-0" size={18} /><span className="truncate text-sm" title={file.name}>{file.name}</span></div><button onClick={() => updateActiveProject(p => ({...p, files: p.files.filter((_, i) => i !== index)}))} className="text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><X size={16} /></button></li>))}</ul>}
            </div>

            {/* Khu v·ª±c C∆° s·ªü tri th·ª©c n·ªôi b·ªô */}
            <div className="flex-grow flex flex-col min-h-0">
              <div className="flex justify-between items-center mb-2">
                  <button onClick={() => updateActiveProject(p => ({...p, isKnowledgeBaseCollapsed: !p.isKnowledgeBaseCollapsed}))} className="flex items-center gap-2 text-lg font-semibold text-slate-700 hover:text-indigo-600 transition-colors">
                      <BookMarked size={20} /><span>C∆° s·ªü tri th·ª©c</span>
                      <ChevronDown size={20} className={`transition-transform ${activeProject.isKnowledgeBaseCollapsed ? '-rotate-90' : ''}`} />
                  </button>
                  <div className="flex items-center gap-3">
                      <label htmlFor="kb-upload" className="cursor-pointer text-slate-500 hover:text-indigo-600" title="T·∫£i l√™n C∆° s·ªü tri th·ª©c"><Upload size={18} /></label>
                      <input id="kb-upload" type="file" className="hidden" onChange={handleKnowledgeBaseUpload} accept=".txt,.pdf,.md,.docx,.xlsx" />
                      <button onClick={handleDownloadKnowledgeBase} className="text-slate-500 hover:text-indigo-600" title="T·∫£i xu·ªëng C∆° s·ªü tri th·ª©c"><Download size={18} /></button>
                  </div>
              </div>
              <div className={`transition-all duration-300 ease-in-out overflow-hidden flex-grow flex flex-col ${activeProject.isKnowledgeBaseCollapsed ? 'max-h-0' : 'max-h-full'}`}>
                  <textarea value={activeProject.knowledgeBase} onChange={(e) => updateActiveProject(p => ({...p, knowledgeBase: e.target.value}))} placeholder="Nh·∫≠p ho·∫∑c d√°n ki·∫øn th·ª©c chuy√™n gia v√†o ƒë√¢y..." className="w-full h-full flex-grow p-2 border border-slate-300 rounded-md resize-none text-sm bg-slate-50 focus:ring-2 focus:ring-indigo-500"/>
              </div>
            </div>
            </div>
          )}
        </aside>

        {/* C·ªôt b√™n ph·∫£i */}
        <main className={`flex flex-col bg-gray-50 h-full transition-all duration-300 ${isSidebarOpen ? 'w-2/3 xl:w-3/4' : 'w-full'}`}>
          <div className="flex-shrink-0 p-2 bg-white border-b border-slate-200">
            <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 text-slate-600 hover:bg-slate-100 rounded-md">
              {isSidebarOpen ? <PanelLeftClose size={20}/> : <PanelLeftOpen size={20}/>}
            </button>
          </div>
          <div className="flex-1 p-6 overflow-y-auto">
            <div className="space-y-6">
              {activeProject && activeProject.messages.map((msg, index) => {
                if (msg.sender === 'system') { return <SystemMessage key={index} msg={msg} />; }
                return (
                  <div key={index} className={`flex items-start gap-3 ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                    {msg.sender === 'bot' && (<div className="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white flex-shrink-0"><Bot size={24} /></div>)}
                    <div className={`max-w-xl p-4 rounded-xl ${msg.sender === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white text-slate-700 shadow-sm rounded-bl-none'}`}>
                      {msg.isReport ? (<div className="prose prose-sm max-w-none" dangerouslySetInnerHTML={{ __html: msg.text.replace(/\n/g, '<br />').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') }}></div>) : (<p className="whitespace-pre-wrap">{msg.text}</p>)}
                    </div>
                    {msg.sender === 'user' && (<div className="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-600 flex-shrink-0"><User size={24} /></div>)}
                  </div>
                );
              })}
              {isLoading && (<div className="flex justify-start gap-3"><div className="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white flex-shrink-0"><Bot size={24} /></div><div className="bg-white text-slate-700 shadow-sm rounded-xl rounded-bl-none p-4 flex items-center gap-2"><Loader className="animate-spin" size={20} /><span>ƒêang x·ª≠ l√Ω...</span></div></div>)}
              <div ref={messagesEndRef} />
            </div>
          </div>
          <div className="p-6 bg-white border-t border-slate-200">
            <div className="flex items-center gap-2 bg-slate-100 rounded-lg p-2">
              <button onClick={handleToggleListening} disabled={isLoading} className={`p-2 rounded-lg ${isListening ? 'bg-red-500 text-white' : 'bg-gray-200 hover:bg-gray-300'} transition-colors`}><Mic size={18} /></button>
              <input type="text" value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && !isLoading && processRequest('chat')} placeholder="H·ªèi b·∫•t c·ª© ƒëi·ªÅu g√¨ ho·∫∑c d√πng micro..." className="w-full bg-transparent focus:outline-none px-2" disabled={isLoading} />
              {isLoading ? (<button onClick={handleStop} className="p-2 rounded-lg bg-red-600 text-white hover:bg-red-700 flex items-center gap-2"><StopCircle size={18} /><span>D·ª´ng</span></button>) : (<div className="flex items-center gap-2 flex-wrap">
                  <button onClick={() => processRequest('chat')} disabled={!input.trim()} className="p-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:bg-blue-300 flex items-center gap-2"><Send size={18} /><span>G·ª≠i</span></button>
                  <button onClick={handleAddToKnowledge} disabled={!input.trim()} className="p-2 rounded-lg bg-teal-600 text-white hover:bg-teal-700 disabled:bg-teal-300 flex items-center gap-2"><BookMarked size={18} /><span>Th√™m v√†o tri th·ª©c</span></button>
                  <button onClick={() => processRequest('expert')} disabled={!input.trim()} className="p-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 disabled:bg-indigo-300 flex items-center gap-2"><ShieldCheck size={18} /><span>H·ªèi Chuy√™n Gia</span></button>
                  <button onClick={() => processRequest('deep_research')} disabled={!input.trim()} className="p-2 rounded-lg bg-green-600 text-white hover:bg-green-700 disabled:bg-green-300 flex items-center gap-2"><BrainCircuit size={18} /><span>Ch√©m gi√≥ s√¢u</span></button>
              </div>)}
            </div>
          </div>
        </main>
      </div>
    </>
  );
}
